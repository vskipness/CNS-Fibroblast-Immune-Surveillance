---
title: "cellchat analysis - fibroblasts & T cells"
date: "2023-06-23"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
editor_options: 
  chunk_output_type: inline
---

```{r include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

# load packages

```{r load packages}
suppressPackageStartupMessages({
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(RColorBrewer)
  library(viridis)
  library(ggsci)
  library(scater)
  library(scran)
  library(pheatmap)
  library(biomaRt)
  library(fgsea)
  library(grid)
  library(gridExtra)
  library(msigdbr)
  library(muscat)
  library(ggpubr)
  library(ExploreSCdataSeurat3)
  library(enrichplot)
  #library(Matrix.utils)
  library(destiny)
  library(clusterProfiler)
  library(org.Mm.eg.db)
  library(DOSE)
  library(CellChat)
  library(patchwork)
  options(stringsAsFactors = FALSE)
  })
```

# load files

```{r load file}
basedir <- here()
EndC <- readRDS(paste0(basedir, "/data/endothelial_cells_annotated.rds"))
Tcells <- readRDS(paste0(basedir, "/data/T_cells_annotated.rds"))
```

# Prep files

```{r preparing files and merge}
Idents(Tcells) <- Tcells$clusterlabel
Tcells <- subset(Tcells, idents = c("NK cells", "ILC2"), invert = T)
Tcells$clusterlabel_cc <- "-"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="γδT")] <- "γδT"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Tcm CD4/CD8")] <- "Tcm CD4/CD8"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Tem CD4")] <- "Tem CD4"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Treg")] <- "Treg"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Te CD4")] <- "Te CD4"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Te CD8")] <- "Te CD8"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="ISG Te CD8")] <- "ISG Te CD8"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Tem CD8")] <- "Tem CD8"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Trm CD8")] <- "Trm CD8"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="ISG Trm CD8")] <- "ISG Trm CD8"
Tcells$clusterlabel_cc[which(Idents(Tcells)=="Cx3cr1+ CD8")] <- "Cx3cr1+ CD8"
unique(Tcells$clusterlabel_cc)

Idents(EndC) <- EndC$clusterlabel
EndC$clusterlabel_cc <- "-"
EndC$clusterlabel_cc[which(Idents(EndC)=="Capillary")] <- "Capillary"
EndC$clusterlabel_cc[which(Idents(EndC)=="Venous")] <- "Venous" 
EndC$clusterlabel_cc[which(Idents(EndC)=="CP EndC")] <- "CP EndC"
EndC$clusterlabel_cc[which(Idents(EndC)=="Arterial")] <- "Arterial" 
EndC$clusterlabel_cc[which(Idents(EndC)=="Capillary/Fbs")] <- "Capillary/Fbs"
unique(EndC$clusterlabel_cc)

## merge
seurat <- merge(EndC, Tcells)
```


# all together

```{r all}
## all
Idents(seurat) <- seurat$clusterlabel_cc
seurat_all <- subset(seurat, downsample = 500)

table(seurat_all$clusterlabel_cc)
seurat <- NormalizeData(object = seurat_all)
```

## create cellchat object 

```{r create CellChat object}
sce <- as.SingleCellExperiment(seurat_all)
rownames(sce) = gsub("^.*\\.", "", rownames(sce))
cellchat <- createCellChat(object = sce, group.by = "clusterlabel_cc")
levels(cellchat@idents) <- c("Venous", "Arterial", "Capillary/Fbs", "Capillary", "CP EndC", "Treg", "Te CD4", "Te CD8", "ISG Te CD8", "Tem CD4", "Tem CD8", "Trm CD8", "ISG Trm CD8", "Tcm CD4/CD8", "ydT", "Cx3cr1+ CD8")
```

```{r set ligand receptor database}
CellChatDB <- CellChatDB.mouse # use CellChatDB.mouse if running on mouse data

# use all CellChatDB except for "Non-protein Signaling" for cell-cell communication analysis
CellChatDB.use <- CellChatDB
cellchat@DB <- CellChatDB.use
```

```{r preprocessing the expression data for cell-cell communication analysis}
# subset the expression data of signaling genes for saving computation cost
cellchat <- subsetData(cellchat) # This step is necessary even if using the whole database
future::plan("multisession", workers = 4) # do parallel
cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat)

# compute communication probability and infer cellular communication network
cellchat <- computeCommunProb(cellchat)
```

```{r set ligand receptor interaction database}
cellchat <- filterCommunication(cellchat, min.cells = 35)
df.net <- subsetCommunication(cellchat)
```

```{r communication probability}

cellchat <- computeCommunProbPathway(cellchat, thresh = 1)
cellchat <- aggregateNet(cellchat)

groupSize <- as.numeric(table(cellchat@idents))
par(mfrow = c(1,2), xpd = T)

netVisual_circle(cellchat@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Interaction weights/strength")

mat <- cellchat@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = groupSize, weight.scale = T, edge.weight.max = max(mat), title.name = rownames(mat)[i])
}
```

## visualization of signalling pathways

```{r heatmap}
# Heatmap

netVisual_heatmap(cellchat, color.heatmap = "RdPu", measure = "weight", sources.use = c("Venous", "Arterial", "Capillary/Fbs", "Capillary", "CP EndC"), targets.use = c("Treg", "Te CD4", "Te CD8", "ISG Te CD8", "Tem CD4", "Tem CD8", "Trm CD8", "ISG Trm CD8", "Tcm CD4/CD8", "ydT", "Cx3cr1+ CD8"))

netVisual_heatmap(cellchat, color.heatmap = "RdPu", measure = "count", sources.use = c("Venous", "Arterial", "Capillary/Fbs", "Capillary", "CP EndC"), targets.use = c("Treg", "Te CD4", "Te CD8", "ISG Te CD8", "Tem CD4", "Tem CD8", "Trm CD8", "ISG Trm CD8", "Tcm CD4/CD8", "ydT", "Cx3cr1+ CD8"))
```

```{r interactions, fig.height=6, fig.width=8}
# Interactions
pairLR.use <- extractEnrichedLR(cellchat, signaling = c("CCL","CXCL", "LAMININ", "NOTCH"))

#levels(cellchat@idents)
#netVisual_bubble(cellchat, sources.use = c("Pericytes","Perivascular fibroblasts", "Vascular smooth muscle cells", "Meningeal fibroblasts", "Tem CD4","Tem CD8", "Tcm CD4/CD8"), pairLR.use = pairLR.use , sort.by.source = T,sort.by.target = T, remove.isolate = TRUE)

netVisual_bubble(cellchat, sources.use = c("Venous", "Arterial", "Capillary/Fbs", "Capillary", "CP EndC"), targets.use = c("Treg", "Te CD4", "Te CD8", "ISG Te CD8", "Tem CD4", "Tem CD8", "Trm CD8", "ISG Trm CD8", "Tcm CD4/CD8", "ydT", "Cx3cr1+ CD8"), pairLR.use = pairLR.use , sort.by.source = T, sort.by.target = T, remove.isolate = TRUE)
```

```{r dotplot }
cellchat <- netAnalysis_computeCentrality(cellchat, slot.name = "netP")

netAnalysis_signalingRole_scatter(cellchat)
```

```{r vln plot}
plotGeneExpression(cellchat, signaling = "CXCL", enriched.only = TRUE, type = "violin")
plotGeneExpression(cellchat, signaling = "CCL", enriched.only = TRUE, type = "violin")
```

# sessionInfo
```{r sessionInfo}
sessionInfo()
date()
```
